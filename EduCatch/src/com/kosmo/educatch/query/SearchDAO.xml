<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kosmo.educatch.dao.SearchMapper">

	<!-- 지역 대분류 -->
	<select id="getDistrict" parameterType="search" resultType="search">
	SELECT DISTRICT
	FROM (SELECT ROWNUM, DISTRICT, RANK() OVER (PARTITION BY DISTRICT
    ORDER BY DISTRICT, CITY) AS RK FROM AREA ORDER BY 1)
    <![CDATA[ WHERE RK <= 1 ]]>
	</select>
	
	<!-- 지역 소분류 -->
	<select id="getCity" parameterType="search" resultType="search">
	SELECT CITY
	FROM (SELECT ROWNUM, A.DISTRICT, A.CITY
		FROM AREA A
		WHERE A.DISTRICT = #{district}
		ORDER BY ROWNUM)
 	</select>
	
	<select id="getAcaList" parameterType="academyview" resultType="academyview">
	SELECT  COUNT(C.ANO) OVER() AS LISTCOUNT
		   ,C.ANO AS ANO
		   ,C.ANAME AS ANAME
		   ,C.ATEL AS ATEL
		   ,C.AADDR1 AS AADDR1
		   ,C.AADDR2 AS AADDR2
		   ,C.ALOGO AS ALOGO
		   ,TRUNC(C.AGRADE,2) AS AGRADE
		   ,D.CMAJOR AS CMAJOR
		   ,D.CMINOR AS CMINOR
		   ,C.AINSERTDATE AS AINSERTDATE
		   ,C.AUPDATEDATE AS AUPDATEDATE
           ,C.RVCOUNT AS RVCOUNT
	FROM   (SELECT  NVL(AVG(B.RBGRADE),0) AS AGRADE
	               ,A.CATEGORY_CNO AS CNO
	               ,A.ANO AS ANO
	               ,A.ANAME AS ANAME
	               ,A.ATEL AS ATEL
	               ,A.AADDR1 AS AADDR1
	               ,A.AADDR2 AS AADDR2
	               ,A.ALOGO AS ALOGO
	               ,TO_CHAR(AINSERTDATE,'YYYY-MM-DD') AS AINSERTDATE
	               ,TO_CHAR(AUPDATEDATE,'YYYY-MM-DD') AS AUPDATEDATE
	               ,COUNT(A.ANO) OVER() AS LISTCOUNT
                   ,COUNT(B.ACADEMY_ANO) AS RVCOUNT
	        FROM   ACADEMY A, REVIEWBOARD B
	        WHERE  B.ACADEMY_ANO(+) = A.ANO
	        AND    A.ADELETEYN = 'N'
	        GROUP BY A.CATEGORY_CNO,A.ANAME,A.ANO,A.ATEL,A.AADDR1,A.AADDR2,A.ALOGO,AINSERTDATE
	        		,AUPDATEDATE,TO_CHAR(AINSERTDATE,'YYYY-MM-DD') ,TO_CHAR(AUPDATEDATE,'YYYY-MM-DD')) C, 
	        CATEGORY D
	WHERE C.CNO = D.CNO
	<if test="district!=null or city!=null or cmajor!=null or cminor!=null">
    AND
    <![CDATA[ C.AADDR1 LIKE '%'||#{district}||'%' ]]>
	AND
	<![CDATA[ C.AADDR1 LIKE '%'||#{city}||'%' ]]>
	AND
	<![CDATA[ D.CMAJOR LIKE '%'||#{cmajor}||'%' ]]>
	<if test="!cminor.equals('전체')">
	AND
	<![CDATA[ D.CMINOR LIKE '%'||#{cminor}||'%' ]]>
	</if>
	</if>
	<if test="aname!=null">
	AND
	<![CDATA[ C.ANAME LIKE '%'||#{aname}||'%' ]]>
	</if>
	<if test="agrade!=null">
	ORDER BY AGRADE DESC
	</if>
	<if test="rvcount!=null">
	ORDER BY RVCOUNT DESC	
	</if>
	</select>
	
</mapper>
